---
import '../styles/global.css';
import type { ImageMetadata } from 'astro';
import socialImage from '../assets/osaango_makes_people_and_integrations_more_agile.png';

interface Props {
  title?: string | undefined;
  description?: string | undefined;
  image?: ImageMetadata | { src: string; width?: number; height?: number; format?: string } | string;
  isHome?: boolean;
  structuredData?: Array<Record<string, unknown>>;
}

const {
  title = 'Osaango - Make people and integrations more Agile for real growth.',
  description = 'We help organisations remove architectural bottlenecks, improve delivery across teams and vendors, and build the practices needed for sustainable growth â€” through better operating models, integration strategy and API design.',
  image,
  isHome = false,
  structuredData = [],
} = Astro.props as Props;

const siteUrl = Astro.site?.href ?? 'https://www.osaango.com/';
const canonicalUrl = new URL(Astro.url?.pathname ?? '/', siteUrl).toString();

const resolveImageMetadata = (
  imageInput: ImageMetadata | { src: string; width?: number; height?: number; format?: string } | string,
) => {
  if (!imageInput) return undefined;

  if (typeof imageInput === 'string') {
    return { src: imageInput };
  }

  if ('src' in imageInput) {
    return {
      src: imageInput.src,
      width: 'width' in imageInput ? imageInput.width : undefined,
      height: 'height' in imageInput ? imageInput.height : undefined,
      format: 'format' in imageInput ? imageInput.format : undefined,
    };
  }

  return undefined;
};

const defaultOpenGraphImage = resolveImageMetadata(socialImage)!;
const resolvedPageImage = image && !isHome ? resolveImageMetadata(image) : undefined;
const pageOpenGraphImage = resolvedPageImage ?? defaultOpenGraphImage;
const openGraphImage = new URL(pageOpenGraphImage.src, siteUrl).toString();
const openGraphImageWidth = pageOpenGraphImage.width ?? 1200;
const openGraphImageHeight = pageOpenGraphImage.height ?? 630;
const openGraphImageType = pageOpenGraphImage.format
  ? `image/${pageOpenGraphImage.format}`
  : 'image/png';
const GA_MEASUREMENT_ID = 'G-35GC5RBXFN';
const structuredDataEntries = [
  {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: 'Osaango',
    url: siteUrl,
    logo: new URL('/favicon.svg', siteUrl).toString(),
    sameAs: ['https://www.linkedin.com/company/osaango/'],
  },
  {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: 'Osaango',
    url: siteUrl,
  },
  {
    '@context': 'https://schema.org',
    '@type': 'WebPage',
    name: title,
    description,
    url: canonicalUrl,
    isPartOf: siteUrl,
    image: openGraphImage,
    primaryImageOfPage: openGraphImage,
  },
  ...structuredData,
];

const structuredDataJson = JSON.stringify(structuredDataEntries);
const analyticsScript = `
  const GA_ID = '${GA_MEASUREMENT_ID}';
  const CONSENT_STORAGE_KEY = 'osano-gtag-consent-state';

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  const getStoredConsent = () => {
    try {
      const stored = localStorage.getItem(CONSENT_STORAGE_KEY);
      return stored ? JSON.parse(stored) : null;
    } catch (error) {
      console.warn('Unable to read stored consent', error);
      return null;
    }
  };

  const persistConsent = (consentUpdate) => {
    try {
      localStorage.setItem(CONSENT_STORAGE_KEY, JSON.stringify(consentUpdate));
    } catch (error) {
      console.warn('Unable to persist consent', error);
    }
  };

  const buildGtagConsentUpdate = (consentState) => {
    const analyticsGranted = Boolean(
      consentState.analytics ?? consentState.statistics ?? consentState.performance,
    );
    const marketingGranted = Boolean(
      consentState.marketing ?? consentState.advertisement ?? consentState.targeting,
    );

    return {
      ad_storage: marketingGranted ? 'granted' : 'denied',
      ad_user_data: marketingGranted ? 'granted' : 'denied',
      ad_personalization: marketingGranted ? 'granted' : 'denied',
      analytics_storage: analyticsGranted ? 'granted' : 'denied',
    };
  };

  const applyConsentUpdate = (consentUpdate, shouldPersist = false) => {
    gtag('consent', 'update', consentUpdate);
    if (shouldPersist) {
      persistConsent(consentUpdate);
    }
  };

  gtag('js', new Date());
  gtag('consent', 'default', {
    ad_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    analytics_storage: 'denied',
  });

  const storedConsent = typeof localStorage !== 'undefined' ? getStoredConsent() : null;
  if (storedConsent) {
    applyConsentUpdate(storedConsent);
  }

  const applyOsanoConsentToGtag = () => {
    const consentState = window.Osano?.cm?.getConsent?.();
    if (!consentState) return;

    const consentUpdate = buildGtagConsentUpdate(consentState);
    applyConsentUpdate(consentUpdate, true);
  };

  window.addEventListener('osano-cm-loaded', applyOsanoConsentToGtag);
  window.addEventListener('osano-cm-consent-changed', applyOsanoConsentToGtag);
  applyOsanoConsentToGtag();

  gtag('config', GA_ID);
`;
---

<meta charset="UTF-8" />
<meta name="description" content={description} />
<meta name="viewport" content="width=device-width" />
<meta name="generator" content={Astro.generator} />
<title>{title}</title>
<link rel="canonical" href={canonicalUrl} />

<meta property="og:type" content="website" />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:site_name" content="Osaango" />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:image" content={openGraphImage} />
<meta property="og:image:width" content={openGraphImageWidth} />
<meta property="og:image:height" content={openGraphImageHeight} />
<meta property="og:image:type" content={openGraphImageType} />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={openGraphImage} />
<meta name="twitter:image:width" content={openGraphImageWidth} />
<meta name="twitter:image:height" content={openGraphImageHeight} />
<script type="application/ld+json" set:html={structuredDataJson}></script>

<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<script src="https://cmp.osano.com/AzZiasU51W8qO2GF2/9c3d7adf-75a0-4fa6-84c3-b2dfea793c24/osano.js"></script>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}></script>
    <script is:inline set:html={analyticsScript}></script>

<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,400;0,700;1,400&family=Rubik:wght@500;600&display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,400;0,700;1,400&family=Rubik:wght@500;600&display=swap"
  media="print"
  onload="this.media='all'"
/>
<noscript>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,400;0,700;1,400&family=Rubik:wght@500;600&display=swap"
  />
</noscript>

<script is:inline>
  // This code is inlined in the head to make dark mode instant & blocking.
  const getThemePreference = () => {
    if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme');
    }
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  };
  const isDark = getThemePreference() === 'dark';
  document.documentElement.classList[isDark ? 'add' : 'remove']('theme-dark');

  if (typeof localStorage !== 'undefined') {
    // Watch the document element and persist user preference when it changes.
    const observer = new MutationObserver(() => {
      const isDark = document.documentElement.classList.contains('theme-dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  }
</script>
